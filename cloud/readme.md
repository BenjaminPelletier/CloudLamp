# "Cloud" Arduino sketch

This sketch is intended to be uploaded to an ESP32 module via the [Arduino IDE](https://www.arduino.cc/) (tested with version 1.8.13) using the "ESP32 Dev Module" board defined in the board definition (File -> Preferences -> Settings -> Additional Boards Manager URLs) at https://dl.espressif.com/dl/package_esp32_index.json.  It requires the [FastLED](https://github.com/FastLED/FastLED) library (tested with version 3.3.3) which can be installed using the Library Manager (Sketch -> Include Library -> Manage Libraries...) simply by searching for "FastLED".  The SK6812-based LED strip from [BTF-Lighting](https://www.btf-lighting.com/) (Model BTF-5V-30L-W, SKU SK68125M30RGBNWW67, 5m 150 LEDs 5V 45 W RGB+natural white) requires a hack for use with FastLED found in [FastLED_RGBW.h](FastLED_RGBW.h).

## Debugging

The primary `Serial` port is used to communicate with the computer (when present) for diagnostics while the secondary `Serial2` port is used to communicate with the Arduino Uno in the base.  [debug](debug.ino) forwards incoming lines from the computer to the Arduino Uno so the developer can command the Arduino Uno directly.  Most communication from the Arduino Uno is also echoed to the primary `Serial` port so the developer can observe the Arduino Uno's responses.

## Thunder sounds

When thunder sounds are generated by "manufacturing" WAV files using [ThunderGen](https://github.com/BenjaminPelletier/ThunderGen), the characteristics of the lightning bolts are also written out to a text file.  This output is hardcoded into [thunder_sounds.h](thunder_sounds.h) so that the lightning timing and intensity can match the thunder sound played after it.  `thunder_delays` contains all the delays between lightning flashes.  The first delay for any given bolt is the time between the first lightning flash and the thunder sound.  Each subsequent delay for any given bolt is the first delay plus the time between the first flash and the flash described by that entry.  For instance, if a particular bolt had `thunder_delays` = {1000, 1100, 1300, 2400}, then there would be flashes at t={0, 100, 300, 1400} milliseconds, and thunder sound would be played at t=1000 milliseconds.  The `thunder_intensities` are the lightning intensity for each lightning flash.  `thunder_offsets` indicates the index within `thunder_delays` and `thunder_intensities` where the corresponding bolt begins.  So, if `thunder_offsets[15]=39` and `thunder_offsets[16]=44`, then the 15th bolt (15th WAV file on SD card in WAV Trigger) consists of flashes defined in `thunder_delays[39]` to `thunder_delays[43]` and `thunder_intensities[39]` to `thunder_intensities[43]`.